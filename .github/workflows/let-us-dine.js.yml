name: Deploy Let-Us-Dine

on:
    push:
        branches: ["main"]

concurrency:
    group: production-deploy
    cancel-in-progress: true

jobs:
    deploy:
        runs-on: self-hosted
        timeout-minutes: 30

        steps:
            # 1. Clone repository into runner workspace
            - name: Checkout repository
              uses: actions/checkout@v3

            # 2. Setup Node (shared for backend and frontend)
            - name: Setup Node
              uses: actions/setup-node@v3
              with:
                  node-version: "18"

            # ---- CREATE BACKEND .env ----
            - name: Create backend .env file
              run: |
                  cat <<EOF > ./backend/.env
                  DATABASE_URL=${{ secrets.DATABASE_URL }}
                  ADMIN_API_KEY=${{ secrets.ADMIN_API_KEY }}
                  GOOGLE_PLACES_API_KEY=${{ secrets.GOOGLE_PLACES_API_KEY }}
                  FRONTEND_URL=${{ secrets.FRONTEND_URL }}
                  EOF

            # ---- CREATE FRONTEND .env ----
            - name: Create backend .env file
              run: |
                  cat <<EOF > ./frontend/.env
                  VITE_API_URL=${{ secrets.VITE_API_URL }}
                  EOF

            # 3. Install + build backend inside workspace
            - name: Install & build backend
              working-directory: ./backend
              run: |
                  npm install
                  npx prisma generate
                  npx prisma migrate deploy
                  npm run build

            # 4. Install + build frontend inside workspace
            - name: Install & build frontend
              working-directory: ./frontend
              run: |
                  npm install
                  npm run build

            # 5. Sync built files to /var/www/let-us-dine (production directory)
            - name: Deploy to server directory
              run: |
                  sudo rsync -a --delete "$GITHUB_WORKSPACE/" /var/www/let-us-dine/

            # 6. Restart backend with PM2
            - name: Restart Backend
              run: |
                  cd /var/www/let-us-dine/backend
                  pm2 restart backend || pm2 start ecosystem.config.js
                  pm2 save

            # 7. Validate nginx config BEFORE reload (prevents stuck reloads!)
            - name: Validate nginx config
              run: sudo nginx -t

            # 8. Reload nginx safely
            - name: Reload nginx
              run: sudo systemctl reload nginx

            # 9. Health check after deployment
            - name: Health Check
              run: |
                  sleep 5
                  curl -f https://letusdine.jorgebuenrostro.com || echo "Site might still be starting..."
