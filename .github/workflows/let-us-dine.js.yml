name: Deploy Let-Us-Dine

on:
    push:
        branches: ["main"]

concurrency:
    group: production-deploy
    cancel-in-progress: true

jobs:
    deploy:
        runs-on: self-hosted
        timeout-minutes: 30

        steps:
            - name: Pull latest code
              run: |
                  cd /var/www/let-us-dine
                  git fetch origin
                  git reset --hard origin/main

            - name: Setup Node
              uses: actions/setup-node@v3
              with:
                  node-version: "18"

            - name: Deploy Backend
              working-directory: /var/www/let-us-dine/backend
              run: |
                  npm i
                  npx prisma generate
                  npx prisma migrate deploy
                  npm run build

            - name: Restart Backend
              working-directory: /var/www/let-us-dine/backend
              run: |
                  pm2 restart backend || pm2 start ecosystem.config.js
                  pm2 save

            - name: Deploy Frontend
              working-directory: /var/www/let-us-dine/frontend
              run: |
                  npm i
                  npm run build

            - name: Reload nginx
              run: systemctl reload nginx

            - name: Health Check
              run: |
                  sleep 5
                  curl -f https://letusdine.jorgebuenrostro.com || echo "Site might still be starting..."
